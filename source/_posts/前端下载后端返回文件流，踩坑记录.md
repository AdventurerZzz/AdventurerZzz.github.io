---
title: 前端下载后端返回文件流，踩坑记录
date: 2024-12-13 10:02:48
tags:
---

本文主要记录前端使用后端返回的文件流进行下载时，下载的文件损坏的问题。

# 问题背景

前端在使用<code>axios</code>下载后端返回的文件流的后,将它转化为 url 然后模拟点击下载，发现下载的文件损坏。以下是最开始代码片段：

```js
Vue.prototype
  .$post(`api/xxxx`, formData)
  .then((response) => {
    // 创建一个 Blob 对象
    const blob = new Blob([response], { type: "application/zip" });
    // 创建一个 URL 对象
    const url = window.URL.createObjectURL(blob);
    window.location.href = url;
    // 注意，这里需要合适的时机去释放 URL 对象，比如可以在页面加载完成等回调中去执行
    window.addEventListener("load", () => {
      window.URL.revokeObjectURL(url);
    });
  })
  .catch((error) => err);
```

我通过这个形式下载下来的 zip 压缩包一直有问题，附图：![err](/img/ziperr.png "err"),随后修改代码如下

```js
Vue.prototype
  .$post(`api/xxxx`, formData, {
    responseType: "blob",
    headers: {
      "Content-Type": "multipart/form-data",
    },
  })
  .then((response) => {
    // 创建一个 URL 对象
    const url = window.URL.createObjectURL(response);
    window.location.href = url;
    // 注意，这里需要合适的时机去释放 URL 对象，比如可以在页面加载完成等回调中去执行
    window.addEventListener("load", () => {
      window.URL.revokeObjectURL(url);
    });
  })
  .catch((error) => err);
```

这种将后端返回的二进制文件流不经过前端自己进行 Blob 处理，减少了一次数据的转化处理，这样下载的文件打开后就没问题了
